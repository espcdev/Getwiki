<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haibit - Wiki Libre</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    /* Mantener los mismos estilos originales */
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8fafc; }
    .wiki-content img { max-width: 100%; height: auto; }
    .wiki-content h1 { font-size: 1.8rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; }
    .wiki-content h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.75rem; }
    .wiki-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .wiki-content p { margin-bottom: 1rem; line-height: 1.6; }
    .wiki-content ul, .wiki-content ol { margin-left: 1.5rem; margin-bottom: 1rem; }
    .wiki-content ul { list-style-type: disc; }
    .wiki-content ol { list-style-type: decimal; }
    .wiki-content a { color: #2563eb; text-decoration: none; }
    .wiki-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
    .wiki-content a:hover { text-decoration: underline; }
    .wiki-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin-left: 0; margin-right: 0; font-style: italic; color: #6b7280; }
    .wiki-content pre { background-color: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
    .wiki-content code { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; background-color: #e5e7eb; padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
    .wiki-content pre code { background-color: transparent; padding: 0; }
    .wiki-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    .wiki-content table th, .wiki-content table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
    .wiki-content table th { background-color: #f1f5f9; }
    .editor-toolbar { position: sticky; top: 0; background-color: white; z-index: 10; border-bottom: 1px solid #e5e7eb; }
    .editor-toolbar button { background: none; border: none; font-size: 1rem; padding: 0.5rem; cursor: pointer; color: #1e3a8a; }
    .editor-toolbar button:hover { background-color: #f1f5f9; }
    .wikilink { color: #2563eb; text-decoration: none; border-bottom: 1px dashed #2563eb; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <nav class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-2 flex justify-between items-center">
      <a href="#" class="text-2xl font-bold text-blue-800 flex items-center" id="logo-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
          <path d="M19.5 14.5v-2.5a1 1 0 0 0-1-1h-1a1 1 0 0 0-1 1v1.5a1 1 0 0 0 1 1h1.5"></path>
          <path d="M19.5 19.5v-1.5a1 1 0 0 0-1-1h-1.5a1 1 0 0 1-1-1v-1.5a1 1 0 0 0-1-1h-1.5"></path>
          <path d="M9.5 4.5v1a1 1 0 0 0 1 1h1.5a1 1 0 0 1 1 1v1.5a1 1 0 0 0 1 1h1.5"></path>
          <path d="M4.5 19.5v-1.5a1 1 0 0 1 1-1h1.5a1 1 0 0 0 1-1v-1.5a1 1 0 0 1 1-1h1.5"></path>
          <path d="M4.5 4.5h3.5a1 1 0 0 1 1 1v1.5a1 1 0 0 0 1 1H12"></path>
        </svg>
        Haibit
      </a>
      <div class="flex items-center">
        <div class="relative mr-2 md:mr-4" id="search-container">
          <input 
            type="text" 
            class="border border-gray-300 rounded-full py-1 px-4 pl-10 w-32 md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
            placeholder="Buscar..." 
            id="search-input"
          >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        <div id="user-profile">
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Perfil" class="w-8 h-8 rounded-full cursor-pointer">
        </div>
      </div>
    </div>
  </nav>

  <main class="flex-grow container mx-auto px-4 py-4">
    <div id="home-page" class="block">
      <div class="mb-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">Wikis recientes</h1>
        <button id="new-wiki-btn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nueva
        </button>
      </div>
      <div id="wiki-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
          <div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div>
          <div class="h-10 bg-gray-100 rounded w-full"></div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
          <div class="h-3 bg-gray-100 rounded w-1/2 mb-4"></div>
          <div class="h-10 bg-gray-100 rounded w-full"></div>
        </div>
      </div>
    </div>

    <div id="wiki-page" class="hidden">
      <div class="mb-4">
        <button id="back-to-home" class="text-blue-600 hover:text-blue-800 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Volver
        </button>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-6">
        <h1 id="wiki-title" class="text-2xl font-bold text-gray-900 mb-2"></h1>
        <div class="flex items-center text-sm text-gray-500 mb-4">
          <span id="wiki-date"></span>
          <span class="mx-2">•</span>
          <span id="wiki-author"></span>
        </div>
        <div id="wiki-content" class="wiki-content prose max-w-none"></div>
        <div class="mt-6 flex justify-end">
          <button id="edit-wiki-btn" class="flex items-center text-blue-600 hover:text-blue-800">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Editar
          </button>
        </div>
      </div>
    </div>

    <div id="editor-page" class="hidden">
      <div class="mb-4 flex justify-between items-center">
        <button id="back-from-editor" class="text-blue-600 hover:text-blue-800 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Cancelar
        </button>
        <button id="save-wiki-btn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Guardar
        </button>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <input 
          type="text" 
          id="editor-title" 
          class="w-full text-xl font-bold text-gray-900 mb-4 border-b border-gray-200 pb-2 focus:outline-none focus:border-blue-500" 
          placeholder="Título de la Wiki"
        >
        <div class="editor-toolbar mb-2 pb-1 flex flex-wrap">
          <button data-format="h1" title="Encabezado 1">H1</button>
          <button data-format="h2" title="Encabezado 2">H2</button>
          <button data-format="h3" title="Encabezado 3">H3</button>
          <button data-format="bold" title="Negrita">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
              <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
            </svg>
          </button>
          <button data-format="italic" title="Cursiva">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="4" x2="10" y2="4"></line>
              <line x1="14" y1="20" x2="5" y2="20"></line>
              <line x1="15" y1="4" x2="9" y2="20"></line>
            </svg>
          </button>
          <button data-format="list-ul" title="Lista">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
          </button>
          <button data-format="list-ol" title="Lista numerada">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="10" y1="6" x2="21" y2="6"></line>
              <line x1="10" y1="12" x2="21" y2="12"></line>
              <line x1="10" y1="18" x2="21" y2="18"></line>
              <path d="M4 6h1v4"></path>
              <path d="M4 10h2"></path>
              <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path>
            </svg>
          </button>
          <button data-format="link" title="Enlace">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
          </button>
          <button data-format="image" title="Imagen">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </button>
          <button data-format="code" title="Código">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
          </button>
          <button data-format="table" title="Tabla">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="3" y1="15" x2="21" y2="15"></line>
              <line x1="9" y1="3" x2="9" y2="21"></line>
              <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
          </button>
          <button data-format="wikilink" title="Wiki Link">[[]]</button>
        </div>
        <textarea 
          id="editor-content" 
          class="w-full h-80 md:h-96 p-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 font-mono text-sm"
          placeholder="Escribe aquí el contenido de tu wiki utilizando wikitexto..."
        ></textarea>
        <div class="mt-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Vista previa</h3>
          <div id="editor-preview" class="wiki-content p-4 border border-gray-200 rounded-lg min-h-[100px]"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-4 mt-8">
    <div class="container mx-auto px-4 text-center text-sm text-gray-600">
      <p>Haibit v0.1 - Wiki libre y colaborativa.</p>
      <div class="mt-2">
        <a href="#" class="text-blue-600 hover:text-blue-800 mx-2">Términos y condiciones</a>
        <a href="#" class="text-blue-600 hover:text-blue-800 mx-2">Privacidad</a>
        <a href="#" class="text-blue-600 hover:text-blue-800 mx-2">Acerca de</a>
      </div>
    </div>
  </footer>

  <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://cwuyqgeortpgvahunlct.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3dXlxZ2VvcnRwZ3ZhaHVubGN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0ODk3NTksImV4cCI6MjA1ODA2NTc1OX0.0XWFw2cQpiqCjO79uVZFVJKzaXL2C0q3QVtQcRS-D0U';
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Elementos DOM y estado
    let currentWikiId = null;
    let wikiList = [];
    let currentUser = { id: 'default-user', username: 'Usuario', avatar_url: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' };
    const elements = {
      homePage: document.getElementById('home-page'),
      wikiPage: document.getElementById('wiki-page'),
      editorPage: document.getElementById('editor-page'),
      wikiList: document.getElementById('wiki-list'),
      editorTitle: document.getElementById('editor-title'),
      editorContent: document.getElementById('editor-content'),
      editorPreview: document.getElementById('editor-preview')
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadWikis();
    });

    function setupEventListeners() {
      // Navegación
      document.getElementById('logo-link').addEventListener('click', showHomePage);
      document.getElementById('back-to-home').addEventListener('click', showHomePage);
      document.getElementById('back-from-editor').addEventListener('click', handleBackFromEditor);
      
      // Acciones de wiki
      document.getElementById('new-wiki-btn').addEventListener('click', showNewWikiEditor);
      document.getElementById('edit-wiki-btn').addEventListener('click', showEditWikiEditor);
      document.getElementById('save-wiki-btn').addEventListener('click', saveWiki);
      
      // Editor
      elements.editorContent.addEventListener('input', updatePreview);
      
      // Botones de formato
      document.querySelectorAll('.editor-toolbar button').forEach(button => {
        button.addEventListener('click', () => applyFormat(button.dataset.format));
      });
      
      // Búsqueda
      document.getElementById('search-input').addEventListener('input', handleSearch);
    }

    // Funciones de navegación
function showHomePage() {
  elements.homePage.style.display = 'block';
  elements.wikiPage.style.display = 'none';
  elements.editorPage.style.display = 'none';
  currentWikiId = null;
}

function showWikiPage(wikiId) {
  currentWikiId = wikiId;
  elements.homePage.style.display = 'none';
  elements.wikiPage.style.display = 'block';
  elements.editorPage.style.display = 'none';
  loadWikiContent(wikiId);
}

function showNewWikiEditor() {
  elements.homePage.style.display = 'none';
  elements.wikiPage.style.display = 'none';
  elements.editorPage.style.display = 'block';
  elements.editorTitle.value = '';
  elements.editorContent.value = '';
  updatePreview();
}

function showEditWikiEditor() {
  const wiki = wikiList.find(w => w.id === currentWikiId);
  if (wiki) {
    elements.editorTitle.value = wiki.title;
    elements.editorContent.value = wiki.content;
    updatePreview();
  }
  elements.homePage.style.display = 'none';
  elements.wikiPage.style.display = 'none';
  elements.editorPage.style.display = 'block';
}

// Cargar wikis desde Supabase
async function loadWikis() {
  try {
    const { data, error } = await supabase
      .from('wikis')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    
    wikiList = data; // Actualizamos la variable de estado
    
    if (data.length === 0) {
      document.getElementById('wiki-list').innerHTML = `
        <div class="p-4 text-gray-500">
          No hay wikis disponibles. ¡Sé el primero en crear una!
        </div>
      `;
      return;
    }

    renderWikiList(data);
    
  } catch (error) {
    console.error('Error loading wikis:', error);
    showErrorState(error);
  }
}

function showErrorState(error) {
    const wikiListEl = document.getElementById('wiki-list');
    wikiListEl.innerHTML = `
        <div class="p-4 text-red-600 bg-red-50 rounded-lg">
            <strong>Error cargando wikis:</strong> ${sanitizeHTML(error.message)}
        </div>
    `;
}

// Guardar wiki
async function saveWiki() {
    const titleInput = document.getElementById('editor-title');
    const contentInput = document.getElementById('editor-content');
    const saveBtn = document.getElementById('save-wiki-btn');

    // Validación básica
    if (!titleInput.value.trim() || !contentInput.value.trim()) {
        alert('¡Título y contenido son obligatorios!');
        return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';

    try {
        const { data, error } = await supabase
            .from('wikis')
            .upsert({
                id: currentWikiId || undefined,
                title: titleInput.value.trim(),
                content: contentInput.value.trim(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();

        if (error) throw error;

        // Actualizar UI
        currentWikiId = data.id;
        titleInput.value = '';
        contentInput.value = '';
        
        showWikiPage(data.id);
        loadWikis();

    } catch (error) {
        console.error('Error al guardar:', error);
        alert(`Error: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Guardar';
    }
}

// Renderizar lista de wikis
function renderWikiList(wikis) {
  const wikiListEl = document.getElementById('wiki-list');
  
  wikiListEl.innerHTML = wikis.map(wiki => `
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow cursor-pointer" 
         data-id="${wiki.id}">
      <h3 class="text-lg font-semibold text-gray-900">${sanitizeHTML(wiki.title)}</h3>
      <div class="mt-2 text-sm text-gray-600">${getExcerpt(wiki.content)}</div>
      <div class="mt-3 text-xs text-gray-400">
        ${formatDate(wiki.created_at)}
      </div>
    </div>
  `).join('');

  // Agregar event listeners a los nuevos elementos
  document.querySelectorAll('#wiki-list > div').forEach(element => {
    element.addEventListener('click', () => {
      showWikiPage(element.dataset.id);
    });
  });
}

// Cargar contenido de wiki
async function loadWikiContent(wikiId) {
  try {
    const { data: wiki, error } = await supabase
      .from('wikis')
      .select('*')
      .eq('id', wikiId)
      .single();

    if (error) throw error;

    document.getElementById('wiki-title').textContent = wiki.title;
    document.getElementById('wiki-date').textContent = formatDate(wiki.created_at);
    document.getElementById('wiki-author').textContent = currentUser.username;
    document.getElementById('wiki-content').innerHTML = renderWikiContent(wiki.content);
    
  } catch (error) {
    console.error('Error loading wiki:', error);
    document.getElementById('wiki-content').innerHTML = `
      <div class="text-red-500">Error cargando el contenido: ${error.message}</div>
    `;
  }
}

// Funciones del editor
function updatePreview() {
  elements.editorPreview.innerHTML = renderWikiContent(elements.editorContent.value);
}

function applyFormat(format) {
  const textarea = elements.editorContent;
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  
  const formats = {
    h1: `# ${selectedText}`,
    h2: `## ${selectedText}`,
    h3: `### ${selectedText}`,
    bold: `**${selectedText}**`,
    italic: `*${selectedText}*`,
    'list-ul': `- ${selectedText.split('\n').join('\n- ')}`,
    'list-ol': selectedText.split('\n').map((l, i) => `${i+1}. ${l}`).join('\n'),
    link: `[${selectedText}](url)`,
    image: `![${selectedText}](url)`,
    code: `\`\`\`\n${selectedText}\n\`\`\``,
    table: `| Header 1 | Header 2 |\n|----------|----------|\n| Cell 1   | Cell 2   |`,
    wikilink: `[[${selectedText}]]`
  };

  if (formats[format]) {
    textarea.value = textarea.value.slice(0, start) + formats[format] + textarea.value.slice(end);
    textarea.focus();
    textarea.selectionStart = start + formats[format].length;
    textarea.selectionEnd = start + formats[format].length;
    updatePreview();
  }
}

// Funciones auxiliares
function sanitizeHTML(text) {
    if (!text) return ''; // Manejar valores nulos/undefined
    return String(text).replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function getExcerpt(content, length = 100) {
  if (!content) return '';
  const plainText = content
    .replace(/#+\s*/g, '') // Eliminar encabezados
    .replace(/!?\[.*?\]\(.*?\)/g, '') // Eliminar imágenes y enlaces
    .replace(/<\/?[^>]+(>|$)/g, '') // Eliminar HTML
    .substring(0, length);
  
  return plainText.length >= length ? plainText + '...' : plainText;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const options = { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  };
  return date.toLocaleDateString('es-ES', options);
}

function processImages(html) {
  return html.replace(/src="(.*?)"/g, (match, url) => {
    const corsProxy = 'https://corsproxy.io/?';
    return `src="${corsProxy}${encodeURIComponent(url)}" loading="lazy"`;
  });
}

// Manejar búsqueda
function handleSearch(e) {
  const term = e.target.value.toLowerCase();
  const filtered = wikiList.filter(w => 
    w.title.toLowerCase().includes(term) || 
    w.content.toLowerCase().includes(term)
  );
  renderWikiList(filtered);
}

// Manejar navegación desde editor
function handleBackFromEditor() {
  currentWikiId ? showWikiPage(currentWikiId) : showHomePage();
}

// Función para renderizar el contenido wiki con sintaxis personalizada
function renderWikiContent(content) {
  // Procesar enlaces wiki [[Título]]
  const withWikiLinks = content.replace(
    /\[\[([^\]]+)\]\]/g, 
    '<a href="#" class="wikilink" data-title="$1">$1</a>'
  );

  // Convertir markdown a HTML
  const htmlContent = marked.parse(withWikiLinks);
  const withProxy = processImages(htmlContent);

  // Sanitizar el HTML
  const cleanHTML = DOMPurify.sanitize(htmlContent, {
    ALLOWED_TAGS: [
      'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'p', 'br', 'em', 'strong', 'hr',
      'ul', 'ol', 'li', 'a', 'img',
      'blockquote', 'pre', 'code',
      'table', 'thead', 'tbody', 'tr', 'th', 'td'
    ],
    ALLOWED_ATTR: ['href', 'src', 'alt', 'class', 'data-title']
  });

  return cleanHTML;
}

// Ejecuta esto en la consola de desarrollo temporalmente
async function deleteAmongUsPost() {
  const { error } = await supabase
    .from('wikis')
    .delete()
    .eq('title', 'Among Us'); // Ajusta el filtro según tu caso

  if (!error) console.log('Post de Among Us eliminado');
}

deleteAmongUsPost();
  </script>
</body>
</html>
